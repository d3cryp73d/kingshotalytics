<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kingshotalytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text */
        }
        .view {
            transition: opacity 0.3s ease-in-out;
        }
        /* Styling for the Gear Planner slots */
        .gear-slot {
            background-color: #2d3748; /* Darker slot background */
            border: 2px dashed #4a5568;
            color: #a0aec0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            min-height: 100px;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
            position: relative;
            overflow: hidden; /* Hide overflowing text */
        }
        .gear-slot:hover {
            background-color: #4a5568;
            border-color: #718096;
        }
        .gear-slot .slot-icon { font-size: 2rem; margin-bottom: 0.5rem; }
        .gear-slot .slot-name { font-size: 0.8rem; font-weight: 500; }
        .gear-slot .equipped-item-name {
            font-size: 0.9rem;
            font-weight: bold;
            color: #fff;
            text-align: center;
            padding: 0 4px;
        }
        .gear-slot .equipped-item-level {
            font-size: 0.7rem;
            color: #a0aec0;
        }
        .dropdown-menu {
            display: none;
            background-color: #2d3748; /* Dark dropdown */
            border: 1px solid #4a5568;
        }
        .dropdown.active .dropdown-menu {
            display: block;
        }
        .card {
            background-color: #2d3748; /* Dark card background */
        }
        .code-card {
            background-color: #1a202c;
        }
        /* Rarity Colors */
        .border-rarity-grey { border-color: #9ca3af; }
        .border-rarity-green { border-color: #4ade80; }
        .border-rarity-blue { border-color: #60a5fa; }
        .border-rarity-purple { border-color: #c084fc; }
        .border-rarity-gold { border-color: #facc15; }
        /* Gear Selection Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
        }
        .modal-content {
            background-color: #2d3748;
            margin: 10% auto;
            padding: 2rem;
            border: 1px solid #4a5568;
            width: 90%;
            max-width: 600px;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="text-gray-200">

    <header class="bg-[#2d3748] shadow-lg sticky top-0 z-20">
        <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
            <a href="#" id="nav-brand" class="text-2xl font-bold text-white">Kingshotalytics</a>
            <div class="hidden md:flex items-center space-x-6">
                <a href="#" id="nav-dashboard" class="text-gray-300 hover:text-blue-400 font-medium">Dashboard</a>
                <a href="#" id="nav-builder" class="text-gray-300 hover:text-blue-400 font-medium">Gear Planner</a>
                <a href="#" id="nav-rankings" class="text-gray-300 hover:text-blue-400 font-medium hidden">Player Rankings</a>

                <div class="relative dropdown">
                    <button class="text-gray-300 hover:text-blue-400 font-medium focus:outline-none">Tools <i class="fas fa-chevron-down text-xs"></i></button>
                    <div class="dropdown-menu absolute left-0 mt-2 w-56 rounded-md shadow-lg py-1 z-30">
                        <a href="#" id="nav-calendar" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-600">Event Calendar</a>
                        <a href="#" id="nav-battle-report" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-600">Battle Report Analyzer</a>
                        <a href="#" id="nav-daily-checklist" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-600">Daily Checklist</a>
                        <a href="#" id="nav-pack-calculator" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-600">Pack Value Calculator</a>
                        <a href="#" id="nav-construction-calculator" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-600">Construction Calculator</a>
                        <a href="#" id="nav-troop-calculator" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-600">Troop Training Calculator</a>
                        <a href="#" id="nav-healing-calculator" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-600">Healing Calculator</a>
                    </div>
                </div>

                <div class="relative dropdown">
                    <button class="text-gray-300 hover:text-blue-400 font-medium focus:outline-none">Guides <i class="fas fa-chevron-down text-xs"></i></button>
                    <div class="dropdown-menu absolute left-0 mt-2 w-56 rounded-md shadow-lg py-1 z-30">
                        <a href="#" id="nav-kingdom-transfer" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-600">Kingdom Transfer</a>
                        <a href="#" id="nav-kingdom-reviews" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-600">Kingdom Reviews</a>
                    </div>
                </div>

                <div class="relative dropdown">
                    <button class="text-gray-300 hover:text-blue-400 font-medium focus:outline-none">Information <i class="fas fa-chevron-down text-xs"></i></button>
                    <div class="dropdown-menu absolute left-0 mt-2 w-56 rounded-md shadow-lg py-1 z-30">
                         <a href="#" id="nav-treasure-map" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-600">Treasure Island Map*</a>
                         <a href="#" id="nav-kingshot-map" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-600">Kingshot Map</a>
                         <a href="#" id="nav-building-info" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-600">Building Information</a>
                         <a href="#" id="nav-research-info" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-600">Research Information</a>
                         <a href="#" id="nav-community-blog" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-600">Community Blog</a>
                    </div>
                </div>

                 <div class="relative dropdown">
                    <button class="text-gray-300 hover:text-blue-400 font-medium focus:outline-none">Tier Lists <i class="fas fa-chevron-down text-xs"></i></button>
                     <div class="dropdown-menu absolute left-0 mt-2 w-48 rounded-md shadow-lg py-1 z-30">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-400 cursor-not-allowed">PvE DPS</a>
                    </div>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                 <div class="relative">
                    <input type="search" id="search-input" class="bg-gray-700 text-white rounded-full py-2 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500 w-32 md:w-48 transition-all" placeholder="Search...">
                    <i class="fas fa-search absolute right-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
                <div id="auth-status-container">
                    <button id="google-signin-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Sign In</button>
                    <div id="user-info" class="hidden items-center">
                        <span id="user-name" class="text-white mr-4"></span>
                        <button id="sign-out-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Sign Out</button>
                    </div>
                </div>
                </div>
        </nav>
    </header>

    <main id="app" class="container mx-auto p-4 mt-6">

        <div id="home-view" class="view">
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 space-y-8">
                    <div id="recently-added-card" class="card p-8 rounded-xl shadow-lg">
                        <h2 class="text-3xl font-bold mb-6 text-white">Recently Added</h2>
                        <ul id="recently-added-list" class="list-disc list-inside space-y-3">
                             <li>
                                <span class="text-gray-300">Gear Planner is now live! Plan your builds and see your stats.</span>
                                <a href="#" class="patch-link text-blue-400 hover:underline ml-2" data-patch="1-13">[Details v1.13]</a>
                            </li>
                            <li>
                                <span class="text-gray-300">New Info Section: Treasure Island event map.</span>
                                <a href="#" class="patch-link text-blue-400 hover:underline ml-2" data-patch="1-12">[Details v1.12]</a>
                            </li>
                            <li>
                                <span class="text-gray-300">New Info Section: Research tree costs and bonuses.</span>
                                <a href="#" class="patch-link text-blue-400 hover:underline ml-2" data-patch="1-11">[Details v1.11]</a>
                            </li>
                            <li>
                                <span class="text-gray-300">New Info Section: Standard Kingdom Map with buffs.</span>
                                <a href="#" class="patch-link text-blue-400 hover:underline ml-2" data-patch="1-10">[Details v1.10]</a>
                            </li>
                            <li>
                                <span class="text-gray-300">New Info Section: View full building upgrade charts.</span>
                                <a href="#" class="patch-link text-blue-400 hover:underline ml-2" data-patch="1-9">[Details v1.9]</a>
                            </li>
                        </ul>
                        <div class="text-center mt-6">
                            <button id="expand-features-btn" class="text-blue-400 hover:underline">Show All Updates</button>
                        </div>
                    </div>
                    <div class="card p-8 rounded-xl shadow-lg">
                        <h2 class="text-3xl font-bold mb-6 text-white">Game News & Events</h2>
                        <p class="text-gray-400">Latest news will appear here. Check the "Event Calendar" for the current rotation!</p>
                    </div>
                </div>
                <div class="card p-8 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold mb-6 text-white">Redeem Codes</h2>
                    <div id="redeem-codes-list" class="space-y-4"></div>
                </div>
            </div>
        </div>

        <div id="builder-view" class="view hidden">
            <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                <h1 class="text-3xl font-bold text-white">Gear Planner</h1>
                <div class="flex flex-col md:flex-row gap-2">
                    <input type="text" id="loadout-name" placeholder="Enter Loadout Name" class="bg-gray-700 text-white rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="save-loadout-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Save Loadout</button>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 grid grid-cols-2 md:grid-cols-3 gap-6" id="gear-slots-container">
                    </div>
                <div class="card p-6 rounded-xl shadow-lg h-fit">
                    <h2 class="text-2xl font-bold mb-4 text-white border-b border-gray-600 pb-2">Total Stats</h2>
                    <div id="total-stats-container" class="space-y-2 text-lg"></div>
                </div>
            </div>
        </div>

        <div id="rankings-view" class="view hidden"></div>
        <div id="calendar-view" class="view hidden"></div>
        <div id="kingdom-reviews-view" class="view hidden"></div>
        <div id="kingdom-transfer-view" class="view hidden"></div>
        <div id="battle-report-analyzer-view" class="view hidden"></div>
        <div id="daily-checklist-view" class="view hidden"></div>
        <div id="pack-value-calculator-view" class="view hidden"></div>
        <div id="community-blog-view" class="view hidden"></div>
        <div id="construction-calculator-view" class="view hidden"></div>
        <div id="troop-training-calculator-view" class="view hidden"></div>
        <div id="healing-calculator-view" class="view hidden"></div>
        <div id="building-info-view" class="view hidden"></div>
        <div id="kingshot-map-view" class="view hidden"></div>
        <div id="research-info-view" class="view hidden"></div>
        <div id="treasure-island-map-view" class="view hidden"></div>
    </main>

    <div id="gear-modal" class="modal">
        <div class="modal-content text-white">
            <h2 class="text-2xl font-bold mb-4" id="modal-title">Select Gear</h2>
            <div class="space-y-4">
                <div>
                    <label for="modal-troop-type" class="block mb-2 text-sm font-medium">Troop Type</label>
                    <select id="modal-troop-type" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        <option value="infantry">Infantry</option>
                        <option value="lancer">Lancer</option>
                        <option value="marksman">Marksman</option>
                    </select>
                </div>
                <div>
                    <label for="modal-gear-piece" class="block mb-2 text-sm font-medium">Gear Piece</label>
                    <select id="modal-gear-piece" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        </select>
                </div>
                <div>
                    <label for="modal-rarity" class="block mb-2 text-sm font-medium">Rarity</label>
                    <select id="modal-rarity" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        <option value="grey">Grey</option>
                        <option value="green">Green</option>
                        <option value="blue">Blue</option>
                        <option value="purple">Purple</option>
                        <option value="gold">Gold</option>
                    </select>
                </div>
                <div>
                    <label for="modal-level" class="block mb-2 text-sm font-medium">Level: <span id="modal-level-value">1</span></label>
                    <input id="modal-level" type="range" min="1" max="100" value="1" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="modal-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="modal-confirm-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Confirm</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- FIREBASE CONFIG (REPLACE WITH YOURS) ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // --- DATA STRUCTURES ---
        const GEAR_DATA = {
            infantry: {
                helm: { name: "Infantry Helm", stats: { power: [1,2,3,4,5], attack: [1,2,3,4,5], defense: [1,2,3,4,5], health: [1,2,3,4,5], lethality: [0,0,0,0,0], infHealth: [1,2,3,4,5] } },
                greaves: { name: "Infantry Greaves", stats: { power: [1,2,3,4,5], attack: [1,2,3,4,5], defense: [1,2,3,4,5], health: [1,2,3,4,5], lethality: [0,0,0,0,0], infHealth: [1,2,3,4,5] } },
                gloves: { name: "Infantry Gloves", stats: { power: [1,2,3,4,5], attack: [1,2,3,4,5], defense: [1,2,3,4,5], health: [1,2,3,4,5], lethality: [0,0,0,0,0], infHealth: [1,2,3,4,5] } },
                shroud: { name: "Infantry Shroud", stats: { power: [1,2,3,4,5], attack: [1,2,3,4,5], defense: [1,2,3,4,5], health: [1,2,3,4,5], lethality: [0,0,0,0,0], infHealth: [1,2,3,4,5] } },
            },
            lancer: {
                armet: { name: "Lancer Armet", stats: { power: [1,2,3,4,5], attack: [1,2,3,4,5], defense: [1,2,3,4,5], health: [1,2,3,4,5], lethality: [0,0,0,0,0], lancHealth: [1,2,3,4,5] } },
                boots: { name: "Lancer Boots", stats: { power: [1,2,3,4,5], attack: [1,2,3,4,5], defense: [1,2,3,4,5], health: [1,2,3,4,5], lethality: [0,0,0,0,0], lancHealth: [1,2,3,4,5] } },
                gauntlet: { name: "Lancer Gauntlet", stats: { power: [1,2,3,4,5], attack: [1,2,3,4,5], defense: [1,2,3,4,5], health: [1,2,3,4,5], lethality: [0,0,0,0,0], lancHealth: [1,2,3,4,5] } },
                breastplate: { name: "Lancer Breastplate", stats: { power: [1,2,3,4,5], attack: [1,2,3,4,5], defense: [1,2,3,4,5], health: [1,2,3,4,5], lethality: [0,0,0,0,0], lancHealth: [1,2,3,4,5] } },
            },
            marksman: {
                faceplate: { name: "Marksman Faceplate", stats: { power: [1,2,3,4,5], attack: [1,2,3,4,5], defense: [1,2,3,4,5], health: [1,2,3,4,5], lethality: [0,0,0,0,0], markHealth: [1,2,3,4,5] } },
                riders: { name: "Marksman Riders", stats: { power: [1,2,3,4,5], attack: [1,2,3,4,5], defense: [1,2,3,4,5], health: [1,2,3,4,5], lethality: [0,0,0,0,0], markHealth: [1,2,3,4,5] } },
                bracers: { name: "Marksman Bracers", stats: { power: [1,2,3,4,5], attack: [1,2,3,4,5], defense: [1,2,3,4,5], health: [1,2,3,4,5], lethality: [0,0,0,0,0], markHealth: [1,2,3,4,5] } },
                leatherwear: { name: "Marksman Leatherwear", stats: { power: [1,2,3,4,5], attack: [1,2,3,4,5], defense: [1,2,3,4,5], health: [1,2,3,4,5], lethality: [0,0,0,0,0], markHealth: [1,2,3,4,5] } },
            }
        };
        const GEAR_SLOTS = [
            { id: 'helm', name: 'Helm', icon: 'fa-hard-hat', troop: 'infantry' },
            { id: 'greaves', name: 'Greaves', icon: 'fa-shoe-prints', troop: 'infantry' },
            { id: 'gloves', name: 'Gloves', icon: 'fa-hand-paper', troop: 'infantry' },
            { id: 'shroud', name: 'Shroud', icon: 'fa-user-secret', troop: 'infantry' },
            { id: 'armet', name: 'Armet', icon: 'fa-helmet-safety', troop: 'lancer' },
            { id: 'boots', name: 'Boots', icon: 'fa-shoe-prints', troop: 'lancer' },
            { id: 'gauntlet', name: 'Gauntlet', icon: 'fa-hand-sparkles', troop: 'lancer' },
            { id: 'breastplate', name: 'Breastplate', icon: 'fa-shield-halved', troop: 'lancer' },
            { id: 'faceplate', name: 'Faceplate', icon: 'fa-mask', troop: 'marksman' },
            { id: 'riders', name: 'Riders', icon: 'fa-person-military-rifle', troop: 'marksman' },
            { id: 'bracers', name: 'Bracers', icon: 'fa-hand-fist', troop: 'marksman' },
            { id: 'leatherwear', name: 'Leatherwear', icon: 'fa-vest-patches', troop: 'marksman' },
        ];

        let db, auth, currentUserId = null;
        let currentLoadout = {}; // State for equipped gear
        let currentSlot = null; // Which slot is being edited

        window.addEventListener('DOMContentLoaded', async () => {
            // --- App Initialization ---
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // --- Element References ---
            const elements = {
                gearSlotsContainer: document.getElementById('gear-slots-container'),
                totalStatsContainer: document.getElementById('total-stats-container'),
                gearModal: document.getElementById('gear-modal'),
                modalTitle: document.getElementById('modal-title'),
                modalTroopType: document.getElementById('modal-troop-type'),
                modalGearPiece: document.getElementById('modal-gear-piece'),
                modalRarity: document.getElementById('modal-rarity'),
                modalLevel: document.getElementById('modal-level'),
                modalLevelValue: document.getElementById('modal-level-value'),
                modalCancelBtn: document.getElementById('modal-cancel-btn'),
                modalConfirmBtn: document.getElementById('modal-confirm-btn'),
                googleSignInBtn: document.getElementById('google-signin-btn'),
                signOutBtn: document.getElementById('sign-out-btn'),
                userInfo: document.getElementById('user-info'),
                userName: document.getElementById('user-name')
            };

            // --- AUTHENTICATION LOGIC - START ---
            const updateAuthUI = (user) => {
                if (user) {
                    currentUserId = user.uid;
                    elements.googleSignInBtn.classList.add('hidden');
                    elements.userInfo.classList.remove('hidden');
                    elements.userName.textContent = user.displayName || 'Anonymous';
                    // Show gear planner and other user-specific nav items
                    document.getElementById('nav-builder').classList.remove('hidden');
                } else {
                    currentUserId = null;
                    elements.googleSignInBtn.classList.remove('hidden');
                    elements.userInfo.classList.add('hidden');
                    elements.userName.textContent = '';
                     // Hide gear planner and other user-specific nav items
                    document.getElementById('nav-builder').classList.add('hidden');
                }
            };

            onAuthStateChanged(auth, updateAuthUI);

            elements.googleSignInBtn.addEventListener('click', async () => {
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.error("Error signing in with Google:", error);
                }
            });

            elements.signOutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Error signing out:", error);
                }
            });
            // --- AUTHENTICATION LOGIC - END ---


            // --- UI Generation ---
            const createGearSlots = () => {
                elements.gearSlotsContainer.innerHTML = '';
                GEAR_SLOTS.forEach(slot => {
                    const slotEl = document.createElement('div');
                    slotEl.className = 'gear-slot';
                    slotEl.dataset.slot = slot.id;
                    slotEl.dataset.troop = slot.troop;
                    slotEl.innerHTML = `
                        <i class="fas ${slot.icon} slot-icon"></i>
                        <span class="slot-name">${slot.name}</span>
                    `;
                    slotEl.addEventListener('click', () => openGearModal(slot.id, slot.troop));
                    elements.gearSlotsContainer.appendChild(slotEl);
                });
            };
            
            const updateTotalStatsUI = () => {
                 const totals = {power:0, attack:0, defense:0, health:0, lethality:0, infHealth:0, lancHealth:0, markHealth:0};
                 // In a real implementation, this would calculate from currentLoadout and GEAR_DATA
                 elements.totalStatsContainer.innerHTML = `
                    <div class="flex justify-between"><span>Power:</span> <span>${totals.power}</span></div>
                    <div class="flex justify-between"><span>Attack:</span> <span>${totals.attack.toFixed(2)}%</span></div>
                    <div class="flex justify-between"><span>Defense:</span> <span>${totals.defense.toFixed(2)}%</span></div>
                    <div class="flex justify-between"><span>Health:</span> <span>${totals.health.toFixed(2)}%</span></div>
                    <div class="flex justify-between"><span>Lethality:</span> <span>${totals.lethality.toFixed(2)}%</span></div>
                    <hr class="border-gray-600 my-2">
                    <div class="flex justify-between"><span>Infantry Health:</span> <span>${totals.infHealth.toFixed(2)}%</span></div>
                    <div class="flex justify-between"><span>Lancer Health:</span> <span>${totals.lancHealth.toFixed(2)}%</span></div>
                    <div class="flex justify-between"><span>Marksman Health:</span> <span>${totals.markHealth.toFixed(2)}%</span></div>
                 `;
            };

            // --- Modal Logic ---
            const openGearModal = (slotId, troop) => {
                currentSlot = slotId;
                elements.modalTitle.textContent = `Select Gear for ${slotId.charAt(0).toUpperCase() + slotId.slice(1)}`;
                elements.modalTroopType.value = troop;
                populateGearPieces(troop);
                elements.gearModal.style.display = 'flex';
            };

            const closeGearModal = () => {
                elements.gearModal.style.display = 'none';
                currentSlot = null;
            };

            const populateGearPieces = (troop) => {
                 elements.modalGearPiece.innerHTML = '';
                 const potentialItems = GEAR_DATA[troop];
                 if(potentialItems && potentialItems[currentSlot]){
                     const gear = potentialItems[currentSlot];
                     const option = document.createElement('option');
                     option.value = currentSlot;
                     option.textContent = gear.name;
                     elements.modalGearPiece.appendChild(option);
                 }
            };
            
            elements.modalTroopType.addEventListener('change', (e) => populateGearPieces(e.target.value));
            elements.modalLevel.addEventListener('input', (e) => elements.modalLevelValue.textContent = e.target.value);
            elements.modalCancelBtn.addEventListener('click', closeGearModal);
            
            elements.modalConfirmBtn.addEventListener('click', () => {
                const selectedGear = {
                    troop: elements.modalTroopType.value,
                    piece: elements.modalGearPiece.value,
                    rarity: elements.modalRarity.value,
                    level: parseInt(elements.modalLevel.value, 10),
                };
                currentLoadout[currentSlot] = selectedGear;
                updateSlotUI(currentSlot);
                updateTotalStatsUI();
                closeGearModal();
            });

            const updateSlotUI = (slotId) => {
                const slotData = currentLoadout[slotId];
                const slotEl = elements.gearSlotsContainer.querySelector(`[data-slot="${slotId}"]`);
                if(slotData && slotEl) {
                    const gearInfo = GEAR_DATA[slotData.troop][slotData.piece];
                    slotEl.innerHTML = `
                        <span class="equipped-item-name">${gearInfo.name}</span>
                        <span class="equipped-item-level">Level ${slotData.level}</span>
                    `;
                    slotEl.style.borderStyle = 'solid';
                    slotEl.className = `gear-slot border-rarity-${slotData.rarity}`;
                }
            };
            
            // --- Initial Setup ---
            createGearSlots();
            updateTotalStatsUI();
            // This is a placeholder for view switching logic
            // switchView('home-view'); 
        });
    </script>
</body>
</html>
